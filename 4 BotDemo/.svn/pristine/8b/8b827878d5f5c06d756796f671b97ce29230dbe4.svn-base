using Microsoft.CognitiveServices.SpeechRecognition;
using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;

namespace SpeechPrototype.Model
{
    public class SpeechToText : IDisposable
    {
        public event EventHandler<SpeechToTextEventArgs> OnSttStatusUpdated;
        private DataRecognitionClient _dataRecClient;
        private MicrophoneRecognitionClient _micRecClient;
        private SpeechRecognitionMode _speechMode = SpeechRecognitionMode.LongDictation;
        private string _language = "en-US";
        private bool _isMicRecording = false;

        public SpeechToText(string bingApiKey)
        {
            _dataRecClient = SpeechRecognitionServiceFactory.
                CreateDataClientWithIntent(_language, bingApiKey,
                    "7a196ead-0901-4edb-9c5e-ea8f078c776e",
                    "b39807c6060549749b12449ff3eaf1c2");
            _micRecClient = SpeechRecognitionServiceFactory.
                CreateMicrophoneClient(_speechMode, _language, bingApiKey);
            Initialize();
        }

        private void Initialize()
        {
            _micRecClient.OnMicrophoneStatus += OnMicrophoneStatus;
            _micRecClient.OnPartialResponseReceived += OnPartialResponseReceived;
            _micRecClient.OnResponseReceived += OnResponseReceived;
            _micRecClient.OnConversationError += OnConversationErrorReceived;
            _dataRecClient.OnIntent += OnIntentReceived;
            _dataRecClient.OnPartialResponseReceived += OnPartialResponseReceived;
            _dataRecClient.OnConversationError += OnConversationErrorReceived;
            _dataRecClient.OnResponseReceived += OnResponseReceived;
        }

        private void OnPartialResponseReceived(object sender, PartialSpeechResponseEventArgs e)
        {
            Debug.WriteLine($"Partial response received: { e.PartialResult}");
        }

        private void OnMicrophoneStatus(object sender, MicrophoneEventArgs e)
        {
            Debug.WriteLine($"Microphone status changed to recording: { e.Recording}");
        }

        private void RaiseSttStatusUpdated(SpeechToTextEventArgs e)
        {
            OnSttStatusUpdated?.Invoke(this, e);
        }

        private void SpeechToText_OnSttStatusUpdated(object sender, SpeechToTextEventArgs e)
        {
            throw new NotImplementedException();
        }

        private void OnIntentReceived(object sender, SpeechIntentEventArgs e)
        {
            SpeechToTextEventArgs args = new
                SpeechToTextEventArgs(SttStatus.Success,
                $"Intent received: {e.Intent.ToString()}.\nPayload: { e.Payload }"); 

            RaiseSttStatusUpdated(args);
        }

        private void OnConversationErrorReceived(object sender,
        SpeechErrorEventArgs e)
        {
            if (_isMicRecording) StopMicRecording();

            string message = 
                $"Speech to text failed with status code: { e.SpeechErrorCode.ToString()}, and error message: { e.SpeechErrorText} ";
            SpeechToTextEventArgs args = new
                SpeechToTextEventArgs(SttStatus.Error, message);

            RaiseSttStatusUpdated(args);
        }

        private void StopMicRecording()
        {
            _micRecClient.EndMicAndRecognition();
            _isMicRecording = false;
        }

        private void OnResponseReceived(object sender, SpeechResponseEventArgs e)
        {
            if (_isMicRecording) StopMicRecording();

            RecognizedPhrase[] recognizedPhrases = e.PhraseResponse.Results;
            List<string> phrasesToDisplay = new List<string>();
            foreach (RecognizedPhrase phrase in recognizedPhrases)
            {
                phrasesToDisplay.Add(phrase.DisplayText);
            }

            SpeechToTextEventArgs args = new
            SpeechToTextEventArgs(SttStatus.Success,
                $"STT completed with status: { e.PhraseResponse.RecognitionStatus.ToString() }",
                phrasesToDisplay);

            RaiseSttStatusUpdated(args);
        }

        public void StartMicToText()
        {
            _micRecClient.StartMicAndRecognition();
            _isMicRecording = true;
        }

        public void StartAudioFileToText(string audioFileName)
        {
            using (FileStream fileStream =
                new FileStream(audioFileName, FileMode.Open, FileAccess.Read))
            {
                int bytesRead = 0;
                byte[] buffer = new byte[1024];

                try
                {
                    do
                    {
                        bytesRead = fileStream.Read(buffer, 0, buffer.Length);
                        _dataRecClient.SendAudio(buffer, bytesRead);
                    }
                    while (bytesRead > 0);
                }
                catch (Exception ex)
                {
                    Debug.WriteLine($"Exception caught: {ex.Message}");
                }
                finally
                {
                    _dataRecClient.EndAudio();
                }
            }
        }


        public void Dispose()
        {
            if (_micRecClient != null)
            {
                _micRecClient.EndMicAndRecognition();
                _micRecClient.OnMicrophoneStatus -= OnMicrophoneStatus;
                _micRecClient.OnPartialResponseReceived -= OnPartialResponseReceived;
                _micRecClient.OnResponseReceived -= OnResponseReceived;
                _micRecClient.OnConversationError -= OnConversationErrorReceived;
                _micRecClient.Dispose();
                _micRecClient = null;
            }
            if (_dataRecClient != null)
            {
                _dataRecClient.OnIntent -= OnIntentReceived;
                _dataRecClient.OnPartialResponseReceived -= OnPartialResponseReceived;
                _dataRecClient.OnConversationError -= OnConversationErrorReceived;
                _dataRecClient.OnResponseReceived -= OnResponseReceived;
                _dataRecClient.Dispose();
                _dataRecClient = null;
            }
        }
    }

    public enum SttStatus { Success, Error }

    public class SpeechToTextEventArgs : EventArgs
    {
        public SttStatus Status { get; private set; }
        public string Message { get; private set; }
        public List<string> Results { get; private set; }
        public SpeechToTextEventArgs(SttStatus status,
        string message, List<string> results = null)
        {
            Status = status;
            Message = message;
            Results = results;
        }
    }
}
